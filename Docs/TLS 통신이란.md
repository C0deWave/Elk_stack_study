# TLS 통신이란?

인터넷에서의 정보를 암호화해서 송수신하는 프로토콜. 넷스케이프 커뮤니케이션스사가 개발한 SSL(Secure Sockets Layer)에 기반한 기술로, 국제 인터넷 표준화 기구에서 표준으로 인정받은 프로토콜이다. TCP 443 포트를 사용한다. 
표준에 명시된 정식 명칭은 TLS지만 아직도 SSL이라는 용어가 많이 사용되고 있다.

---

## TLS가 작동하는 방식

정보를 암호화 하기 위해서 필요한 것

* 각 노드별로 신뢰할 수 있는 사용자인지 확인이 필요
* 암호화 통신으로 3자의 도청 방지
* 신뢰할 수 있음을 인증하기 위해 인증서 사용

### **서로의 신원을 확인하고 통신 암호화에 사용할 세션 키를 공유하기 위해 핸드셰이크(Handshake) 과정을 거친다.**

---

![통신과정 이미지](https://github.com/C0deWave/Elk_stack_study/blob/master/Resource/%08TLS%20%ED%86%B5%EC%8B%A0.jpeg?raw=true)

1. 먼저 클라이언트에서 서버에 ClientHello 메시지를 보낸다. 여기에는 클라이언트에서 가능한 TLS 버전, 서버 도메인, 세션 식별자, 암호 설정 등의 정보가 포함된다.

2. 클라이언트의 메시지를 받은 서버는 ServerHello 메시지를 클라이언트에게 보낸다. 여기에는 ClientHello 메시지의 정보 중 서버에서 사용하기로 선택한 TLS 버전, 세션 식별자, 암호 설정 등의 정보가 포함된다.

3. 서버가 클라이언트에 Certificate(공개키) 메시지를 보낸다. 여기에는 서버의 인증서가 들어간다. 이 인증서는 별도의 인증 기관에서 발급받은 것이며, 서버가 신뢰할 수 있는 자임을 인증한다. 전송이 끝나면 ServerHelloDone 메시지를 보내 끝났음을 알린다.

4. 클라이언트는 서버에서 받은 인증서를 검증한다. 인증서의 유효 기간이 만료되지 않았는지, 그 인증서가 해당 서버에게 발급된 인증서가 맞는지 등을 확인한다. 인증서를 신뢰할 수 있다고 판단하였다면 다음 단계로 넘어간다.

5. 클라이언트는 임의의 pre-master secret을 생성한 뒤, 서버가 보낸 인증서에 포함된 공개 키를 사용해 암호화한다. 이렇게 암호화된 pre-master secret을 ClientKeyExchange 메시지에 포함시켜 서버에 전송한다.

6. 서버는 전송받은 정보를 복호화하여 pre-master secret을 알아낸 뒤, 이 정보를 사용해 master secret을 생성한다. 그 뒤 master secret에서 세션 키를 생성해내며, 이 세션 키는 앞으로 서버와 클라이언트 간의 통신을 암호화하는데 사용될 것이다. 물론 클라이언트 역시 자신이 만들어낸 pre-master secret을 알고 있으므로, 같은 과정을 거쳐 세션 키를 스스로 만들 수 있다.

7. 이제 서버와 클라이언트는 각자 동일한 세션 키를 가지고 있으며, 이 키를 사용해 대칭키 암호를 사용하는 통신을 할 수 있다. 따라서 우선 서로에게 ChangeCipherSpec 메시지를 보내 앞으로의 모든 통신 내용은 세션 키를 사용해 암호화해 보낼 것을 알려준 뒤, Finished 메시지를 보내 각자의 핸드셰이킹 과정이 끝났음을 알린다.

8. 이제 서버와 클라이언트 간에 보안 통신이 구성된다.

---

쉽게 요약해서, 먼저 서로가 어떤 TLS 버전을 사용 가능한지를 확인하고, 인증서를 사용해 서로를 믿을 수 있는지 확인한 뒤, 서로간의 통신에 쓸 암호를 교환하는 것이다.(비대칭 암호화 방법을 사용) 

그 다음부터는 서로 교환한 암호를 사용해 제3자가 도청할 수 없는 암호화된 통신을 하면 된다.(대칭키 암호화 방법을 사용)

---

### **대칭키 암호화 방법:** 
대칭 열쇠 암호(symmetric-key algorithm)는 암호화와 복호화에 같은 열쇠(key)를 사용하는 암호를 말한다. 서로만 아는 공통 암호로 암호화해서 전송하는 방법을 사용한다. 비밀키 암호화 방법이라고도 한다.

### **비대칭키 암호화 방법:** 
암호화와 복호화에 사용하는 키가 서로 다른 암호화 방식을 의미한다. 공개키 암호화 방식이라고도 한다.

진행 방식은 다음과 같다.

1. B 가 자신의 공개키를 공개한다.
2. A 는 이 공개키로 문서를 암호화 한다.
3. 암호화된 문서를 B 에게 전달한다.
4. B 는 자신만이 가진 개인키로 이 문서를 해독한다.

비대칭키 암호화 방법을 이용해서 암호키를 공유한 다음 각자의 암호를 이용해 키를 만들어 비밀키 암호화 방식을 사용한 통신을 하는 것이 TLS 방식이다.

이때 공개키는 인증서버에서 인증을 받은 공개키를 사용한다.

---

## 관련 용어

CA: 인증 기관으로써 인증서가 믿을 수 있는 것인지 확인을 해주는 역할을 한다.

Certificate: 인증서로써 해당 인증서를 이요애 암호화를 이용한 통신을 한다.

---

## TLS 1.0

TLS 1.0 버전은 SSL 3.0버전을 업그레이드 한 방식이다. 현재 SSL 1.0, 2.0 3.0 모두 보안 취약점으로 인해 사용이 금지 되었다.

현재는 TLS 1.3버전까지 나왔다.